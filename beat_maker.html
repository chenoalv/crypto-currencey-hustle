<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (keep the existing head content) ... -->
</head>
<body>
    <!-- ... (keep the existing body content) ... -->

    <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const grid = document.getElementById('grid');
        const playPauseButton = document.getElementById('playPause');
        const stopButton = document.getElementById('stop');
        const clearButton = document.getElementById('clear');
        const tempoControl = document.getElementById('tempo');
        const bpmDisplay = document.getElementById('bpm');
        const beatNameInput = document.getElementById('beatName');
        const saveBeatButton = document.getElementById('saveBeat');
        const beatSelect = document.getElementById('beatSelect');
        const loadBeatButton = document.getElementById('loadBeat');
        const soundboard = document.getElementById('soundboard');

        const rows = 4;
        const cols = 8;
        let isPlaying = false;
        let currentBeat = 0;
        let tempo = 120;
        let intervalId;

        const sounds = [
            { name: 'Kick', frequency: 100, decay: 0.1 },
            { name: 'Snare', frequency: 250, decay: 0.05 },
            { name: 'Hi-hat', frequency: 1000, decay: 0.02 },
            { name: 'Clap', frequency: 400, decay: 0.03 }
        ];

        const gainNodes = {};

        // Create grid
        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.row = i;
                cell.dataset.col = j;
                cell.addEventListener('click', toggleCell);
                grid.appendChild(cell);
            }
        }

        // Create soundboard and gain nodes
        sounds.forEach(sound => {
            const gainNode = audioContext.createGain();
            gainNode.connect(audioContext.destination);
            gainNodes[sound.name] = gainNode;

            const soundElement = document.createElement('div');
            const button = document.createElement('button');
            button.textContent = sound.name;
            button.addEventListener('click', () => playSound(sound));
            soundElement.appendChild(button);

            const volumeControl = document.createElement('div');
            volumeControl.className = 'volume-control';
            const volumeSlider = document.createElement('input');
            volumeSlider.type = 'range';
            volumeSlider.min = 0;
            volumeSlider.max = 1;
            volumeSlider.step = 0.1;
            volumeSlider.value = 1;
            volumeSlider.addEventListener('input', (e) => {
                gainNodes[sound.name].gain.setValueAtTime(e.target.value, audioContext.currentTime);
            });
            volumeControl.appendChild(volumeSlider);
            soundElement.appendChild(volumeControl);

            soundboard.appendChild(soundElement);
        });

        function toggleCell(event) {
            event.target.classList.toggle('active');
        }

        function playSound(sound) {
            const oscillator = audioContext.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(sound.frequency, audioContext.currentTime);

            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + sound.decay);

            oscillator.connect(gainNode);
            gainNode.connect(gainNodes[sound.name]);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + sound.decay);
        }

        function playSounds(beat) {
            const activeCells = grid.querySelectorAll(`.cell[data-col="${beat}"].active`);
            activeCells.forEach(cell => {
                const row = parseInt(cell.dataset.row);
                playSound(sounds[row]);
            });
        }

        function startPlayback() {
            if (isPlaying) return;
            isPlaying = true;
            playPauseButton.textContent = 'Pause';
            currentBeat = 0;
            playTick();
        }

        function pausePlayback() {
            isPlaying = false;
            playPauseButton.textContent = 'Play';
            clearTimeout(intervalId);
        }

        function stopPlayback() {
            pausePlayback();
            currentBeat = 0;
            const activeCells = grid.querySelectorAll('.cell.active');
            activeCells.forEach(cell => cell.style.backgroundColor = '');
        }

        function playTick() {
            playSounds(currentBeat);
            const currentCells = grid.querySelectorAll(`.cell[data-col="${currentBeat}"]`);
            currentCells.forEach(cell => cell.style.backgroundColor = '#4a4aff');
            
            const previousBeat = (currentBeat - 1 + cols) % cols;
            const previousCells = grid.querySelectorAll(`.cell[data-col="${previousBeat}"]`);
            previousCells.forEach(cell => cell.style.backgroundColor = '');

            currentBeat = (currentBeat + 1) % cols;
            intervalId = setTimeout(playTick, (60 / tempo) * 1000);
        }

        playPauseButton.addEventListener('click', () => {
            if (isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        });

        stopButton.addEventListener('click', stopPlayback);

        clearButton.addEventListener('click', () => {
            const activeCells = grid.querySelectorAll('.cell.active');
            activeCells.forEach(cell => cell.classList.remove('active'));
        });

        tempoControl.addEventListener('input', (event) => {
            tempo = parseInt(event.target.value);
            bpmDisplay.textContent = `${tempo} BPM`;
            if (isPlaying) {
                pausePlayback();
                startPlayback();
            }
        });

        function saveBeat() {
            const beatName = beatNameInput.value.trim();
            if (!beatName) {
                alert('Please enter a name for your beat.');
                return;
            }

            const beatPattern = [];
            const cells = grid.querySelectorAll('.cell');
            cells.forEach(cell => {
                beatPattern.push(cell.classList.contains('active') ? 1 : 0);
            });

            const beat = { name: beatName, pattern: beatPattern, tempo: tempo };
            let savedBeats = JSON.parse(localStorage.getItem('savedBeats')) || [];
            savedBeats.push(beat);
            localStorage.setItem('savedBeats', JSON.stringify(savedBeats));

            updateBeatList();
            beatNameInput.value = '';
        }

        function loadBeat() {
            const selectedBeat = beatSelect.value;
            if (!selectedBeat) {
                alert('Please select a beat to load.');
                return;
            }

            const savedBeats = JSON.parse(localStorage.getItem('savedBeats')) || [];
            const beat = savedBeats.find(b => b.name === selectedBeat);

            if (beat) {
                const cells = grid.querySelectorAll('.cell');
                cells.forEach((cell, index) => {
                    if (beat.pattern[index] === 1) {
                        cell.classList.add('active');
                    } else {
                        cell.classList.remove('active');
                    }
                });

                tempo = beat.tempo;
                tempoControl.value = tempo;
                bpmDisplay.textContent = `${tempo} BPM`;
            }
        }

        function updateBeatList() {
            const savedBeats = JSON.parse(localStorage.getItem('savedBeats')) || [];
            beatSelect.innerHTML = '<option value="">Select a beat</option>';
            savedBeats.forEach(beat => {
                const option = document.createElement('option');
                option.value = beat.name;
                option.textContent = beat.name;
                beatSelect.appendChild(option);
            });
        }

        saveBeatButton.addEventListener('click', saveBeat);
        loadBeatButton.addEventListener('click', loadBeat);

        updateBeatList();

        // Create stars
        function createStars() {
            const starsContainer = document.querySelector('.stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.style.position = 'absolute';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 3}px`;
                star.style.height = star.style.width;
                star.style.backgroundColor = 'white';
                star.style.borderRadius = '50%';
                star.style.opacity = Math.random();
                star.style.animation = `twinkle ${Math.random() * 5 + 5}s linear infinite`;
                starsContainer.appendChild(star);
            }
        }

        createStars();
    </script>
</body>
</html>
